面向对象
===

开篇
---

+ 基本概念 
  + 类。类是具体事物的抽象。通常类定义了事物的属性和所能完成的工作。有一点需要注意，并不是所有的面向对象编程语言的类都具有class这个明确的实体。例如Javascript就不是基于类的。 Javascript中的类(Function)也具有类定义的特性。这也印证了面向对象只是一种编程范式
  + 对象。对象是类的实例。对象是具体的
  + 方法。方法是类定义对象可以做的事情
  + 继承性。继承是类的具体化，子类是比具备更多特性和行为的类。面向对象是对现实世界的一个抽象。在很多时候的关系并不一定是继承关系。能在一定程序上实现代码的重用
  + 封装性、抽象性。封装性能实现的复杂性隐藏，减少出错的可能

类的结构和实现
---

+ _zend_class_entry 类的内部存储结构
  + name 类名
  + type 类别 (ZEND_INTERNAL_CLASS/ZEND_USER_CLASS)
  + parent 父类
  + refcount 引用计数
  + ce_flags 类的类型
  + function_table 函数列表
  + interfaces 接口列表
  + filename 存放文件绝对路径
  + line_start 类开始行数
  + line_end 类结束行数

+ 类的几种类型
  + 常规类 T_CLASS
  + 抽象类 T_ABSTRACT T_CLASS
  + final 类 T_FINAL T_CLASS
  + 没有加abstract关键字的抽象类 ZEND_ACC_IMPLICIT_ABSTRACT_CLASS
  + 接口 ZEND_ACC_INTERFACE
```
/* 常规类为0，在这里没有定义 */
#define ZEND_ACC_IMPLICIT_ABSTRACT_CLASS    0x10
#define ZEND_ACC_EXPLICIT_ABSTRACT_CLASS    0x20
#define ZEND_ACC_FINAL_CLASS                0x40
#define ZEND_ACC_INTERFACE                  0x80
```

+ zend_do_begin_class_declaration() 用来处理类名，类的类别和父类

+ zend_do_end_class_declaration() 用来处理接口和类的中间代码

类的成员变量
---

+ zend_do_declare_property 检查成员变量不允许的一些情况
  + 接口中不允许使用成员变量
  + 成员变量不能拥有抽象属性
  + 不能声明成员变量为final
  + 不能重复声明属性

+ default_properties 常规的成员变量最后都会注册到类结构的这个字段中

+ get_class_vars() 获取类的成员变量

+ default_static_members 类本身的静态变量存放在类结构的这个字段中

类的成员方法
---

+ zend_initialize_class_data 初始化了整个方法列表所在的哈希表

+ get_class_methods 获取类的成员方法

+ zend_fetch_class 通过类名在 EG(class_table) 中查找类

+ zend_std_get_static_method 查找 ce->function_table 列表，在查找到方法后检查方法的访问控制权限

类的定义
---

+ zend_declare_property* 系列函数为类定义属性

+ ZEND_METHOD 为类定义方法

+ 类方法声明时可以使用的掩码
```
/* fn_flags代表可以在定义方法时使用 */
/* zend_property_info.flags代表可以在定义属性时使用 */
/* ce_flags代表在定义zend_class_entry时候可用 */
#define ZEND_ACC_STATIC                     0x01     /* fn_flags, zend_property_info.flags */
#define ZEND_ACC_ABSTRACT                   0x02     /* fn_flags */
#define ZEND_ACC_FINAL                      0x04     /* fn_flags */
#define ZEND_ACC_IMPLEMENTED_ABSTRACT       0x08     /* fn_flags */
#define ZEND_ACC_IMPLICIT_ABSTRACT_CLASS    0x10     /* ce_flags */
#define ZEND_ACC_EXPLICIT_ABSTRACT_CLASS    0x20     /* ce_flags */
#define ZEND_ACC_FINAL_CLASS                0x40     /* ce_flags */
#define ZEND_ACC_INTERFACE                  0x80     /* ce_flags */
#define ZEND_ACC_INTERACTIVE                0x10     /* fn_flags */
#define ZEND_ACC_PUBLIC                     0x100    /* fn_flags, zend_property_info.flags */
#define ZEND_ACC_PROTECTED                  0x200    /* fn_flags, zend_property_info.flags */
#define ZEND_ACC_PRIVATE                    0x400    /* fn_flags, zend_property_info.flags */
#define ZEND_ACC_PPP_MASK	            (ZEND_ACC_PUBLIC | ZEND_ACC_PROTECTED | ZEND_ACC_PRIVATE)
#define ZEND_ACC_CHANGED                    0x800    /* fn_flags, zend_property_info.flags */
#define ZEND_ACC_IMPLICIT_PUBLIC            0x1000   /* zend_property_info.flags; unused (1) */
#define ZEND_ACC_CTOR                       0x2000   /* fn_flags */
#define ZEND_ACC_DTOR                       0x4000   /* fn_flags */
#define ZEND_ACC_CLONE                      0x8000   /* fn_flags */
#define ZEND_ACC_ALLOW_STATIC               0x10000  /* fn_flags */
#define ZEND_ACC_SHADOW                     0x20000  /* fn_flags */
#define ZEND_ACC_DEPRECATED                 0x40000  /* fn_flags */
#define ZEND_ACC_CLOSURE                    0x100000 /* fn_flags */
#define ZEND_ACC_CALL_VIA_HANDLER           0x200000 /* fn_flags */
```

访问控制
---

+ 访问控制的相关常量
```
#define ZEND_ACC_PUBLIC     0x100
#define ZEND_ACC_PROTECTED  0x200
#define ZEND_ACC_PRIVATE    0x400
#define ZEND_ACC_PPP_MASK   (ZEND_ACC_PUBLIC | ZEND_ACC_PROTECTED | ZEND_ACC_PRIVATE)
```

继承，多态与抽象类
---

+ zend_do_inheritance() 实现继承的编译函数

+ zend_do_inherit_interfaces() 遍历所有的接口列表

+ do_inherit_parent_constructor() 实现魔术方法继承

+ do_inherit_method_check() 实现继承中的访问控制

+ zend_verify_arg_type() 实现类型提示

+ zend_verify_arg_class_kind() 获取类的类型验证信息

+ instanceof_function() 判断是否为指定类的实例

+ zend_do_implement_interface() 合并接口中的常量列表和方法列表操作
